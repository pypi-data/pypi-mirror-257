image: python:3.6

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYPI_INDEX: "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/api/v4/groups/${CI_PROJECT_NAMESPACE}/-/packages/pypi/simple"
cache:
  paths:
    - .cache/pip

before_script:
  - python --version  # For debugging
  - python -m pip install --upgrade pip setuptools
  - pip config set global.index-url "${PYPI_INDEX}"
  - pip install --pre PDKMaster
  - pip install pyinotify # needed for doit and does not have binary
  - pip install --only-binary ":all:" -r dev-requirements.txt
  - pip install --only-binary ":all:" -r ci-requirements.txt

dist:
  only:
    - main
  variables:
    TWINE_PASSWORD: '${CI_JOB_TOKEN}'
    TWINE_USERNAME: 'gitlab-ci-token'
    TWINE_REPOSITORY_URL: 'https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/pypi'
  script:
    # Need to fetch tags
    - git fetch --depth=1 origin +refs/tags/*:refs/tags/*
    - doit dist
    - python -m twine check --strict dist/*
    - python -m twine upload --verbose dist/*

dist-test:
  except:
    - main
  script:
    # Need to fetch tags
    - git fetch --depth=1 origin +refs/tags/*:refs/tags/*
    - doit dist
    - python -m twine check --strict dist/*

install:
  script:
    - doit install

